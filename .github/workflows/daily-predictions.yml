name: Daily NCAA Predictions

on:
  schedule:
    # Run every day at 12:00 PM UTC (7 AM EST)
    - cron: '0 12 * * *'
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  update-predictions:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: ncaa-prediction-schedule
      cancel-in-progress: false
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run daily pipeline (Database Version)
      id: pipeline
      run: |
        python3 daily_pipeline_db.py 2>&1 | tee pipeline_output.log
        echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
    
    - name: Export data to JSON for frontend
      id: export
      run: |
        python3 scripts/export_to_json.py 2>&1 | tee export_output.log
        echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
    
    - name: Upload pipeline log on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: pipeline-failure-log-${{ github.run_id }}
        path: pipeline_output.log
        retention-days: 7
    
    - name: Commit and push if changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        # Add CSV files (backwards compatibility)
        git add data/*.csv data/*.md predictions.md README.md performance.md bets.md safest_bets.md value_bets.md docs/performance/*.png
        # Add database and JSON exports (new!)
        git add data/ncaa_predictions.duckdb frontend/public/data/*.json
        if git diff --cached --quiet; then
          echo "No changes detected; nothing to commit."
          exit 0
        fi
        git commit -m "Update predictions and stats for $(date +'%Y-%m-%d') [Database: $(du -h data/ncaa_predictions.duckdb | cut -f1)]"
        git pull --rebase --autostash origin main
        git push origin HEAD:main
