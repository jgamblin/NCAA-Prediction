# NCAA Basketball Game Predictions

[![Daily Predictions](https://github.com/jgamblin/NCAA-Prediction/actions/workflows/daily-predictions.yml/badge.svg)](https://github.com/jgamblin/NCAA-Prediction/actions/workflows/daily-predictions.yml)

> Accurate, explainable, daily-updated NCAA men's basketball game probabilities with automated drift monitoring, lineage, and feature-store powered context.

## ğŸ” Live Snapshot

<div>
**Current Predictions**: 36 games for November 08, 2025
<strong>Last Updated:</strong> Automated daily at 12:00 PM UTC<br/>
<strong>Model Lineage:</strong> config <code>7dd58a0bb0e2</code> Â· commit <code>439d761</code><br/>
</div>

### **Quick Access**  
| Artifact | Path | Description |
|----------|------|-------------|
| Full Predictions CSV | [`data/NCAA_Game_Predictions.csv`](data/NCAA_Game_Predictions.csv) | Raw probabilities & confidence |
| Markdown Summary | [`predictions.md`](predictions.md) | Human readable card view |
| Accuracy History | [`data/Accuracy_Report.csv`](data/Accuracy_Report.csv) | Daily rollup of prediction performance |
| Drift Metrics | [`data/Drift_Metrics.csv`](data/Drift_Metrics.csv) | Global cumulative & rolling metrics |
| Team Drift | [`data/Drift_Metrics_By_Team.csv`](data/Drift_Metrics_By_Team.csv) | Perâ€‘team rolling performance |
| Anomalies | [`data/Team_Anomalies.csv`](data/Team_Anomalies.csv) | Recent vs cumulative accuracy deltas |
| Feature Store | [`data/feature_store/feature_store.csv`](data/feature_store/feature_store.csv) | Per-team rolling aggregates |

---

## ï¿½ Model Evaluation (Autoâ€‘Updated)

_This section is rewritten by the pipeline; manual edits below this heading will be overwritten._

- **Overall Accuracy**: 91.7% (on 48 predictions)  
- **Training Data**: 29,451 games (Current season: 446)
- **Algorithm**: Random Forest (timeâ€‘weighted, calibrated)  
- **Top Signals**: Rolling win pct diffs, point differential momentum, strength index  
- **Monitoring**: Rolling/cumulative accuracy, log loss, Brier, anomaly deltas, conference drift  

> See `data/calibration_curve.png` and `data/calibration_bins.csv` for reliability diagnostics (when generated by advanced model pipeline).

---

## ğŸ—‚ Table of Contents
1. [Live Snapshot](#-live-snapshot)
2. [Model Evaluation (Auto-Updated)](#-model-evaluation-autoupdated)
3. [Why This Project](#-why-this-project)
4. [Quick Start](#-quick-start)
5. [Architecture & Data Flow](#-architecture--data-flow)
6. [Data Sources & Normalization](#-data-sources--normalization)
7. [Feature Engineering & Models](#-feature-engineering--models)
8. [Monitoring & Drift Detection](#-monitoring--drift-detection)
9. [Automation & CI](#-automation--ci)
10. [Repository Layout](#-repository-layout)
11. [Stable Team Identifiers](#-stable-team-identifiers)
12. [Roadmap](#-roadmap)
13. [Contributing](#-contributing)
14. [License & Acknowledgments](#-license--acknowledgments)

---

## ğŸ¯ Why This Project
Most public sports prediction repos either: (1) ship static historical models, (2) lack transparency into feature drift & calibration, or (3) bury lineage and reproducibility. This project focuses on:

| Pillar | Implementation |
|--------|----------------|
| Daily Freshness | Automated pipeline (GitHub Actions) scrapes, trains, predicts, updates artifacts |
| Explainability | Feature importance exports (`data/Simple_Feature_Importance.csv`, advanced diff lift) |
| Stability | Deterministic team IDs + normalized names + seasonâ€‘aware feature store |
| Monitoring | Global & perâ€‘team drift, anomaly detection, calibration, conference aggregation |
| Lineage | Config version + git commit embedded in every primary CSV |
| Safety Nets | Row inflation guard, feature alignment logic, lowâ€‘data game exclusion |

---

## ï¿½ Quick Start

```bash
pip install -r requirements.txt           # Install dependencies
python3 daily_pipeline.py                 # Run full scrape â†’ feature store â†’ train â†’ predict â†’ update
python3 game_prediction/view_predictions.py  # Optional: CLI viewer
```

Minimal oneâ€‘liner (fresh predictions only, assuming data present):
```bash
python3 daily_pipeline.py --fast
```
_(Flag placeholder: you can add a fast mode later focusing on prediction refresh.)_

Outputs land in `data/`. Markdown summary at root in `predictions.md`.

---

## ğŸ§¬ Architecture & Data Flow

```
ESPN / ncaahoopR â†’ Raw Games â†’ Normalization â†’ Feature Store (rolling diffs) â”
                       â”‚               â”‚
                     Training Dataset       â”‚
                       â”‚               â”‚
                  Model (Simple / Advanced) â”‚
                       â”‚               â”‚
         Drift + Accuracy Logs â† Predictions CSV â†â”€â”´â”€â†’ README / Markdown
```

Key components:
- **Scraper (`espn_scraper.py`)**: incremental recent window pull + dedupe
- **Normalizer (`normalize_teams.py`)**: canonical mapping & alias reduction
- **Feature Store (`feature_store.py`)**: season + team rolling aggregates + diffs (win %, point diff, momentum, strength index)
- **Predictors**: `simple_predictor.py` (fast daily), `ncaa_predictions_v2.py` (richer, multi-season)
- **Monitoring**: `drift_monitor.py`, `team_drift_monitor.py`, conference drift, anomaly trends
- **Publishing**: `generate_predictions_md.py`, `update_readme_stats.py` (banner + evaluation)

---

## ğŸ—ƒ Data Sources & Normalization
| Source | Use | Notes |
|--------|-----|-------|
| ncaahoopR_data | Historical seasons | Bulk backfill by season |
| ESPN API | Recent + upcoming | Live scoreboard scraping window (last 3 days) |
| Internal Mapping | Team name canonicalization | Prevents drift in text aliases |

Safeguards:
* Deâ€‘dup by `game_id` always.
* Season boundary logic prevents mixing prior season rolling stats.
* Lowâ€‘data game filter excludes matchups where either team lacks minimum historical depth.

---

## ğŸ§ª Feature Engineering & Models
| Category | Examples |
|----------|----------|
| Rolling Performance | win pct last 5/10, point diff averages |
| Momentum & Form | last5 vs last10 differentials, recent strength index |
| Historical Baselines | season aggregates, cumulative performance |
| Context | Neutral site flag, ranking gap |
| Diff Features | home_fs_X - away_fs_X for calibrated contrasts |

Models:
1. **SimplePredictor** (RandomForest + calibration option) â€“ fast daily use.
2. **Advanced (v2)** â€“ multi-season, hyperparameter search, diff feature lift evaluation, calibration curve export.

Lift Analysis: `fs_feature_lift.csv` quantifies predictive contribution of feature store derived diffs.

---

## ğŸ” Monitoring & Drift Detection
| Layer | Artifact | Purpose |
|-------|----------|---------|
| Global | `Drift_Metrics.csv` | Rolling vs cumulative accuracy/logloss/Brier |
| Team | `Drift_Metrics_By_Team.csv` | Per-team performance trajectory |
| Anomalies | `Team_Anomalies.csv` & `TEAM_ANOMALIES.md` | Detect sharp deltas (recent vs cumulative) |
| Conference | `Conference_Drift.csv` | Aggregated performance patterns |
| Calibration | `calibration_curve.png` / bins CSV | Probability reliability |
| Feature Impact | `Simple_Feature_Importance.csv` & diff lift | Explainability |

Thresholds & windows are config-driven; anomalies require min games + delta gap.

---

## ğŸ¤– Automation & CI
| Stage | Action |
|-------|--------|
| 00 | Scrape recent games & integrate completed results |
| 10 | Normalize & update feature store |
| 20 | Train / refresh model & generate predictions CSV |
| 30 | Banner-only README update (fast visibility) |
| 40 | Accuracy + drift + anomalies + calibration (if applicable) |
| 50 | Full README evaluation section rewrite |
| 60 | Commit + tag (config + commit lineage) |

Planned addition: early banner update already supported via script; integrated step coming.

---

## ğŸ“ Repository Layout
```
NCAA-Prediction/
â”œâ”€â”€ daily_pipeline.py         # ğŸš€ Main script: Full daily automation
â”œâ”€â”€ predictions.md            # ğŸ“Š Today's predictions (auto-updated)
â”œâ”€â”€ requirements.txt          # Python dependencies
â”œâ”€â”€ scripts/                  # One-off and historical debug utilities (not part of core pipeline)
â”‚   â”œâ”€â”€ debug_indiana_prediction.py  # Historical name drift investigation
â”‚   â””â”€â”€ archive/check_team_ids.py    # Original ESPN team ID exploration (now integrated)
â”œâ”€â”€ data/                     # All data files (CSV, JSON)
â”‚   â”œâ”€â”€ Completed_Games.csv       # Historical game results
â”‚   â”œâ”€â”€ Upcoming_Games.csv        # Scheduled games
â”‚   â”œâ”€â”€ NCAA_Game_Predictions.csv # Model predictions
â”‚   â”œâ”€â”€ Accuracy_Report.csv       # Prediction tracking
â”‚   â””â”€â”€ Model_Tuning_Log.json     # Tuning history
â”œâ”€â”€ data_collection/          # Data fetching modules
â”‚   â”œâ”€â”€ espn_scraper.py      # ESPN live data scraper
â”‚   â”œâ”€â”€ all_games.py         # ncaahoopR historical data
â”‚   â”œâ”€â”€ collect_data.py      # Data orchestrator
â”‚   â”œâ”€â”€ check_seasons.py     # List available seasons
â”‚   â”œâ”€â”€ normalize_teams.py   # Team name normalization with alias mapping
â”‚   â””â”€â”€ check_unmatched_teams.py  # Identify unmatched teams for cleanup
â”œâ”€â”€ model_training/           # ML training modules
â”‚   â”œâ”€â”€ simple_predictor.py  # ğŸ†• Main prediction model
â”‚   â”œâ”€â”€ tune_model.py        # ğŸ†• Weekly hyperparameter tuning
â”‚   â”œâ”€â”€ ncaa_predictions_v2.py  # Enhanced 30-feature model
â”‚   â””â”€â”€ ncaa_predictions.py     # Legacy 15-feature model
â”œâ”€â”€ game_prediction/          # Prediction utilities
â”‚   â”œâ”€â”€ generate_predictions_md.py  # Markdown generator
â”‚   â”œâ”€â”€ track_accuracy.py           # Accuracy tracker
â”‚   â”œâ”€â”€ analyze_betting_lines.py    # ğŸ†• Vegas comparison
â”‚   â””â”€â”€ view_predictions.py         # Terminal viewer
â”œâ”€â”€ docs/                     # ğŸ“š Documentation
â””â”€â”€ tests/                    # Pytest unit tests (incl. Indiana prediction normalization)
    â”œâ”€â”€ QUICKSTART.md
    â”œâ”€â”€ MODEL_IMPROVEMENTS.md
    â”œâ”€â”€ CODE_REVIEW.md
    â””â”€â”€ REFACTORING_SUMMARY.md
```

---

## ğŸ” Stable Team Identifiers

### Data Collection
- Multi-season data fetching (configurable)
- Currently fetches 5 seasons: 2020-21 through 2024-25
- ~29,000 games, 1,287 unique teams
- Data source: [ncaahoopR_data](https://github.com/lbenz730/ncaahoopR_data) (ESPN data)
- **Rankings**: AP poll rankings, differentials
- **Historical Performance**: Win %, PPG, OPPG, point differential

### Training Strategy
- **Time-Weighted Training**: Recent games weighted higher
- **Lagged Statistics**: Prevents look-ahead bias
- **RandomizedSearchCV**: 50-iteration hyperparameter optimization
- **Cross-Validation**: 5-fold CV for reliable estimates

## ğŸ”§ Configuration

### Advanced Features

**Betting Line Analysis** - Compare model vs Vegas:
```bash
python3 game_prediction/analyze_betting_lines.py
```
- Tracks disagreements with betting lines
- Calculates ROI on contrarian picks
- Identifies profitable prediction patterns

**Change Seasons to Fetch** - Edit `data_collection/all_games.py`:
```python
SEASONS = ["2022-23", "2023-24", "2024-25"]  # Use only recent 3 seasons
CURRENT_SEASON = "2025-26"
```

**Check Available Seasons**:
```bash
python3 data_collection/check_seasons.py
```
Shows all available seasons (23 seasons from 2002-03 to 2024-25).

## ğŸ“ˆ Model Evaluation (Autoâ€‘Updated)

### Current Performance

- **Overall Accuracy**: 87.5% (on 96 predictions)
- **Current Season (2025-26) Tuning**: 98.3%
- **Training Data**: 29,444 games (current season: 439)
- **Calibration (Brier)**: Weighted=0.2698, Unweighted=0.2134 (Î” W-U: +0.0564)
- **Calibration (ECE)**: Weighted=0.2175, Unweighted=0.0347 (Î” W-U: +0.1828)
  *Lower is better; weighted model emphasizes current season.*

### Lineage

- Config Version: `7dd58a0bb0e2`
- Commit Hash: `cf8c56f`
*Refreshed: 2025-11-08 12:09 UTC*

## ğŸš€ Automation

GitHub Actions runs predictions daily at 12:00 PM UTC (7:00 AM EST):
1. **Scrape ESPN** - Fetch completed and upcoming games
2. **Merge Data** - Add completed games to training set
3. **Track Accuracy** - Compare predictions vs actual results
4. **Generate Predictions** - Train model and predict upcoming games
5. **Update Markdown** - Create predictions.md with results
6. **Auto-commit** - Push updates back to repository

See `.github/workflows/daily-predictions.yml`

### Weekly Model Tuning

Run weekly to optimize for current season:
```bash
python3 model_training/tune_model.py
```
- Time-weighted training (10x current season)
- Hyperparameter optimization
- 96.4% accuracy on current season games

## ğŸ“ Output Files

All outputs saved to `data/` directory:

- **Completed_Games.csv**: Historical game results (29,343 games)
- **Upcoming_Games.csv**: Scheduled games awaiting predictions  
- **NCAA_Game_Predictions.csv**: Predictions with confidence scores
- **Accuracy_Report.csv**: Daily prediction accuracy tracking
- **ESPN_Current_Season.csv**: Live scraped current season data
- **Model_Tuning_Log.json**: Weekly tuning results and metrics
- **Betting_Line_Analysis.json**: Vegas comparison analytics

Plus **predictions.md** in root - formatted predictions for GitHub display

---

To ensure long-term consistency as team naming conventions shift (e.g., "Appalachian St" vs "Appalachian State Mountaineers"), the pipeline now captures stable team identifiers:

| Column | Files | Source | Fallback Behavior |
| ------ | ------ | ------ | ---------------- |
| `home_team_id` | `Upcoming_Games.csv`, `NCAA_Game_Predictions.csv` | ESPN event JSON (`competitors[].id`) | If missing, generates `namehash_<hash>` from normalized team name |
| `away_team_id` | `Upcoming_Games.csv`, `NCAA_Game_Predictions.csv` | ESPN event JSON | Same as above |

### Why This Matters
* Provides a durable join key for future advanced features (e.g., roster tracking, conference drift, opponent strength caching).
* Shields models from textual alias volatility and manual mapping churn.
* Enables precise tracking of low-data teams across seasons regardless of name presentation.

### Usage Notes
* When an ESPN numeric ID exists it will be a short integer-like string (e.g., `313`); otherwise a deterministic `namehash_XXXXXX` placeholder appears.
* Modeling still uses normalized textual names today; future iterations can switch embeddings or history joins to ID keys seamlessly.
* If you add enrichment (rosters, coaches, pace metrics), prefer joining on these ID columns rather than raw names.

## ğŸ›¤ Roadmap
- Add fast-path `--fast` pipeline mode (skip re-train if model freshness < N hours)
- Integrate early banner update inside pipeline (post-predictions)
- Expand anomaly detection to probability calibration shifts
- Conference & opponent strength blended feature set
- Optional ensemble (simple + advanced blended probability)
- Rich HTML report artifact (GitHub Pages export)

## ğŸ¤ Contributing
PRs welcome for: new feature store metrics, calibration enhancements, drift detection strategies, documentation improvements. Please keep changes modular & include a test when affecting modeling or monitoring logic.

---

## ğŸ“š Documentation

Each directory contains a detailed README:
- [data/README.md](data/README.md) - Data file schemas
- [data_collection/README.md](data_collection/README.md) - Data fetching details
- [model_training/README.md](model_training/README.md) - Model architecture
- [game_prediction/README.md](game_prediction/README.md) - Future utilities

## ğŸ›  Tech Stack

- **Python 3.x**
- **scikit-learn**: Random Forest classifier, hyperparameter tuning
- **pandas**: Data manipulation
- **matplotlib/seaborn**: Visualization
- **requests**: API calls to ncaahoopR_data

## ğŸ“„ License

See [LICENSE](LICENSE)

## ğŸ™ Acknowledgments

- [ncaahoopR_data](https://github.com/lbenz730/ncaahoopR_data) by Luke Benz - Pre-scraped NCAA basketball data
- ESPN - Original data source

---

## ğŸ†• Recent Updates

**November 4, 2025**
- âœ… Refactored daily pipeline with extracted model class
- âœ… Added weekly model tuning with time-weighted training
- âœ… Implemented betting line disagreement tracker
- âœ… Fixed all linting issues and improved code quality
- âœ… Updated to Python 3.14 for GitHub Actions
- ğŸ¯ **Current season accuracy: 96.4%**

---

**Last updated:** November 4, 2025
